{% extends 'base.html' %}

{% block title %}Luo uusi kysely{% endblock %}

{% block head %}
  <script src="{{ url_for('static', filename='js/create_survey.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/create_survey.css') }}">
{% endblock %}

{% block content %}
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <!-- Removing sortability
  <script>
    $( function() {
            $("#choiceTable").sortable({
              items: "tr:not(#newRow)"
            });
    })
  </script>
  -->
  <script>
      $( document ).ready(function() {
        $("#start-date").datepicker({
          dateFormat: "dd.mm.yy"
        });
        $("#end-date").datepicker({
          dateFormat: "dd.mm.yy"
        });
      });
  </script>
    <h1 class="page-title">
      <img src="{{ url_for('static', filename='images/note_add_white_36dp.svg') }}"
           alt=""
           class="d-inline-block align-text-middle"
      >
      Luo uusi kysely
    </h1>

    <section>
      <h2>Kyselyn nimi</h2>
      <input
          type="text"
          class="form-control"
          id="groupname" name="groupname"
          validation-regex=".{5,}"
          validation-text="Kyselyn nimen tulee olla vähintään 5 merkkiä pitkä"
          onchange="fieldIsValid(this)"
          {% if survey.surveyname %}
            value="{{survey.surveyname}}"
          {% endif %}
      />
      <ul class="validation-warnings-list hidden">
        <li><span class="input-validation-warning" id="groupname-validation-warning"></span></li>
      </ul>
      
    </section>

    <section>
      <h2>Vastausaika</h2>
      <p>Vastausaika määrittää aikavälin, jolloin kyselyyn on mahdollista vastata.</p>
      <label>Vastausaika alkaa:</label><br />
      <input data-role="date" type="text" id="start-date" class="datetime-input-field" name="startdate" validation-regex="\d\d\.\d\d\.\d\d\d\d" validation-text="Päivämäärän tulee olla muodossa pp.kk.yyyy">
      <label for="starttime" class="time-label">Kello:</label><input type="time" name="starttime" id="starttime" class="datetime-input-field" validation-regex="\d\d\:\d\d" validation-text="Ajan tulee olla muodossa hh.mm"/>
      <br/>
      <ul class="validation-warnings-list hidden">
        <li><span class="input-validation-warning" id="startdate-validation-warning"></span></li>
        <li><span class="input-validation-warning" id="starttime-validation-warning"></span></li>
      </ul>
      <label>Vastausaika päättyy:</label><br />
      <input data-role="date" type="text" id="end-date" class="datetime-input-field" name="enddate" validation-regex="\d\d\.\d\d\.\d\d\d\d" validation-text="Päivämäärän tulee olla muodossa pp.kk.yyyy">
      <label for="endtime" class="time-label">Kello:</label><input type="time" name="endtime" id="endtime" class="datetime-input-field" validation-regex="\d\d\:\d\d" validation-text="Ajan tulee olla muodossa hh.mm"/>
      <ul class="validation-warnings-list hidden">
        <li><span class="input-validation-warning" id="enddate-validation-warning"></span></li>
        <li><span class="input-validation-warning" id="endtime-validation-warning"></span></li>
      </ul>
    </section>

    <section>
      <h2>Kyselyn kuvaus</h2>
      <p>Tähän voit antaa kuvauksen kyselystä ja ohjeita siihen vastaamiseen. Kuvausteksti näytetään vastaajalle kyselyn yhteydessä</p>
      <textarea id="survey-information" class="form-control">{% if survey.surveyname %}{{survey.survey_description}}{% endif %}</textarea>
    </section>

    <section>
      <h2>Priorisoitujen ryhmien vähimmäismäärä</h2>
      <input
          type="text"
          class="form-control"
          id="minchoices" name="minchoices"
          validation-regex="\d+"
          validation-text="Kentän tulee olla kokonaisluku"
          onchange="fieldIsValid(this)"
          {% if survey.minchoices %}
            value="{{survey.minchoices}}"
          {% endif %}
        />
        <ul class="validation-warnings-list hidden">
          <li><span class="input-validation-warning" id="minchoices-validation-warning"></span></li>
        </ul>
    </section>

    <section>
      <h2>Priorisoitavat ryhmät</h2>
      <p>Syötä ryhmät jotka kyselyyn vastaaja voi asettaa mielekkyysjärjestykseen. Anna kullekkin ryhmälle myös sen enimmäiskoko. Halutessasi voit lisätä lisätietoa kohteesta omiin sarakkeisiinsa. Sarakkeen voit luoda painamalla "+ Lisää tietokenttä".</p>
      <input id="choiceFileInput" type="file" style="display: none;" onchange="handleFileUpload()"/>
      <button onclick="uploadChoiceFileBtn()" class="btn btn-secondary" name="uploadChoiceFile">Tuo valinnat CSV-tiedostosta</button>
      <table class="table table-dark table-striped table-hover choice-table-main">
        <thead class="">
          <tr id="table-headers">
            <th class="constant-header" col-validation-regex=".{5,}">Nimi</th>
            <th class="constant-header" col-validation-regex="\d+">Enimmäispaikat</th>
          {# additional columns if template loaded with survey parameter present #}
          {% if survey is not none %}
            {% for info in survey.choices[0].info_columns %}
              <th>{{info.info_key}}</th>
            {% endfor %}
          {% endif %}
            <th class="variable-header" id="add-column-header">+ Lisää tietokenttä</th>
          </tr>
        </thead>
        <tbody id="choiceTable" class="">
        {# If survey parameter is present, create rows for each choice #}
        {% if survey is not none %}
          {% if survey.choices|length > 0 %}
            {% for choice in survey.choices %}
              <tr>
                <td>{{ choice.name }}</td>
                <td>{{ choice.max_spaces }}</td>
              {% for info in choice.info_columns %}
                <td>{{info.info_value}}</td>
              {% endfor %}
              </tr>
            {% endfor %}

          {# If survey parameter is not set, create empty row with columns for constant values #}
          {% else %}
            <tr>
              <td class="empty">tyhjä</td>
              <td class="empty">tyhjä</td>
            </tr>
          {% endif %}
          {% else %}
            <tr>
              <td class="empty">tyhjä</td>
              <td class="empty">tyhjä</td>
            </tr>
        {% endif %}
          
        </tbody>
      </table>
      <span class="input-validation-warning" for="choice-table-main"></span>

      <button onclick="addRow()" class="new-row-input btn btn-secondary" name="addchoice">+ Lisää vaihtoehto</button>
    </section>

    <section>
      <button type="submit" class="btn btn-primary" value="Luo kysely" onclick="createNewSurvey()" name="createsurvey">Luo kysely</button>
    </section>
{% endblock %}